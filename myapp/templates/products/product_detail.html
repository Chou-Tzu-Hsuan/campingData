{% extends "base.html" %}
{% block title %}<title>ç”¢å“åç´°</title> {% endblock  %}
{% block style %}

<style>
  .btn-xs {
    padding: 2px 8px;
    font-size: 0.75rem;
    line-height: 1.2;
    border-radius: 4px;
  }
</style>
{% endblock%}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-l p-4 mx-auto w-100" style="font-family: Arial, sans-serif;">
    <div class="row g-4">
      <!-- ğŸ“· åœ–ç‰‡æ¬„ï¼Œåœ–ç‰‡æ›´å¤§+è¼¸æ’­åŠŸèƒ½ -->
      <div class="col-md-6 d-flex align-items-top justify-content-center">
        {% if product.images.all %}
          <div id="productCarousel" class="carousel slide w-100" data-bs-ride="carousel">
            <div class="carousel-inner text-center">
              {% for img in product.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ img.image.url }}" class="d-block w-100 img-fluid"
                    alt="{{ img.alt_text|default:product.product_name }}"
                    style="max-height: 400px; object-fit: contain;">
              </div>
              {% endfor %}
            </div>
            {% if product.images.count > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">ä¸Šä¸€å¼µ</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">ä¸‹ä¸€å¼µ</span>
            </button>
            {% endif %}
          </div>
        
        {% else %}
          <div class="text-muted">ç„¡åœ–ç‰‡</div>
        {% endif %}
      </div>

      <!-- å•†å“è³‡è¨Šæ¬„ -->
      <div class="col-md-6 d-flex flex-column">
        <h2 class="text-primary mb-3">{{ product.product_name }}</h2>
        <p class="text-muted" style="line-height: 1.6;">{{ product.description }}</p>

        <hr class="my-3">

        <ul class="list-unstyled mb-4 fs-6">
          <li><strong>ğŸ’° åƒ¹æ ¼ï¼š</strong> {{ product.price }} å…ƒ</li>
          <li><strong>ğŸ“¦ åº«å­˜ï¼š</strong> {{ product.stock_quantity }} ä»¶</li>
          <li><strong>ğŸ·ï¸ å“ç‰Œï¼š</strong> {{ product.brand.brand_name }}</li>
          <li><strong>ğŸ—‚ï¸ åˆ†é¡ï¼š</strong> {{ product.category.category_name }}</li>
        </ul>

        <!-- æŒ‰éˆ•æ’å³å´ï¼Œå°å°ºå¯¸ -->
        <div class="mt-auto">
          <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
            <form action="{% url 'add_to_cart' product.pk %}" method="post" class="m-0">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-xs px-3 py-2 fw-semibold shadow-sm rounded">
                ğŸ›’ åŠ å…¥è³¼ç‰©è»Š
              </button>
            </form>

            <button id="wishlist-btn"
                    data-url="{% url 'toggle_wishlist' product.pk %}"
                    class="btn {% if is_favorited %}btn-danger{% else %}btn-outline-danger{% endif %} btn-xs px-3 py-2 fw-semibold shadow-sm rounded">
              {% if is_favorited %}
                â¤ï¸ å–æ¶ˆæ”¶è—
              {% else %}
                â™¡ åŠ å…¥æ”¶è—
              {% endif %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å›å•†å“æ¸…å–® -->
  <div class="text-center mt-4">
    <a href="{% url 'product_list' %}" class="btn btn-primary btn-sm">
      â† å›ç”¢å“æ¸…å–®
    </a>
  </div>
</div>
{% endblock %}



{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const wishlistBtn = document.getElementById('wishlist-btn');

  if (wishlistBtn) {
    wishlistBtn.addEventListener('click', function (e) {
      e.preventDefault();  // é˜²æ­¢é è¨­è·³è½‰è¡Œç‚º
      const url = wishlistBtn.dataset.url;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Accept': 'application/json'
        }
      })
      .then(res => {
        if (res.status === 401) {
          // æœªç™»å…¥ âœ å°å›ç™»å…¥é ï¼Œä¿ç•™è¿”å›å•†å“é 
          window.location.href = `/userlogin/?next={{ request.path }}`;
          return;
        }
        return res.json();
      })
      .then(data => {
        if (!data) return;

        // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
        if (data.status === 'added') {
          wishlistBtn.classList.remove('btn-outline-danger');
          wishlistBtn.classList.add('btn-danger');
          wishlistBtn.innerHTML = 'â¤ï¸ å–æ¶ˆæ”¶è—';
        } else if (data.status === 'removed') {
          wishlistBtn.classList.remove('btn-danger');
          wishlistBtn.classList.add('btn-outline-danger');
          wishlistBtn.innerHTML = 'â™¡ åŠ å…¥æ”¶è—';
        }
      })
      .catch(err => console.error('æ”¶è—æ“ä½œå¤±æ•—:', err));
    });
  }
});
</script>


{% endblock %}

