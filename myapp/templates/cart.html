{% extends "base.html" %}
{% block title %}
    <title>è³¼ç‰©è»Š</title>
{% endblock %}
{% block styles %}
    <style>
    td.word-wrap {
        word-break: break-word;
        max-width: 250px;
    }
    .btn-group-custom {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-top: 20px;
        align-items: center;
    }
    @media (max-width: 576px) {
        .btn-group-custom > * {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }
    table.table-hover tbody tr:hover {
        background-color: #f1f7ff;
    }
    </style>
{% endblock %}
{% block content %}

<!-- å•†å“è³‡è¨Š Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">å•†å“è³‡è¨Š</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalProductImage" src="" alt="å•†å“åœ–ç‰‡" class="img-fluid rounded mb-3" style="max-height: 300px;">
        <h5 id="modalProductName" class="mb-2"></h5>
        <p id="modalProductPrice" class="text-primary fw-bold mb-1" style="font-size: 1.2em;"></p>
        <p id="modalProductDescription" class="text-muted"></p>
      </div>
    </div>
  </div>
</div>

<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4 text-left">ğŸ›’ è³¼ç‰©è»Šå…§å®¹</h2>

    {% if cart_items %}

    <!-- æ›´æ–°è³¼ç‰©è»Šè¡¨å–® -->
    <form id="update-cart-form" method="post" action="{% url 'update_cart' %}">
        {% csrf_token %}
        <input type="hidden" name="go_to_checkout" id="go-to-checkout" value="0" />
        <div class="table-responsive">
            <table class="table table-bordered table-hover bg-white align-middle">
                <thead class="table-primary text-center">
                    <tr>
                         <th style="width: 15%;">å•†å“åœ–ç‰‡</th>
                        <th style="width: 30%;">å•†å“åç¨±</th>
                        <th style="width: 15%;">åƒ¹æ ¼</th>
                        <th style="width: 15%;">æ•¸é‡(å¯ç·¨è¼¯)</th>
                        <th style="width: 15%;">å°è¨ˆ</th>
                        <th style="width: 15%;">å–æ¶ˆ</th>
                    </tr>
                    
                </thead>
                <tbody>
                    {% for product_id, item in cart_items.items %}
                    <tr class="text-center">
                        <td>
                            {% if item.image %}                         
                            <img src="{{ item.image }}" 
                                alt="{{ item.product_name }}" 
                                style="max-width: 80px; max-height: 80px; cursor: pointer;"
                                class="img-fluid rounded shadow-sm mb-2"
                                data-bs-toggle="modal" 
                                data-bs-target="#productModal"
                                onclick="showProductModal('{{ item.product_name }}', '{{ item.image }}', '{{ item.price }}')">
                            {% else %}
                                <span class="text-muted">âŒ ç„¡åœ–ç‰‡</span>
                            {% endif %}
                        </td>

                        <td class="word-wrap text-start">{{ item.product_name|default:"âŒ æœªçŸ¥å•†å“" }}</td>
                        <td>
                            {% if item.price is not None %}
                                ${{ item.price|floatformat:0 }}
                            {% else %}
                                âŒ æœªçŸ¥åƒ¹æ ¼
                            {% endif %}
                        </td>

                        <td>
                            <input
                                type="number"
                                name="quantity_{{ product_id }}"
                                value="{{ item.quantity }}"
                                min="1"
                                max="10"
                                class="form-control form-control-sm quantity-input text-center"
                                data-price="{{ item.price }}"
                                oninput="updateSubtotal(this)"
                                style="max-width: 90px; margin: 0 auto;"
                            />
                        </td>

                        <td class="subtotal-cell fw-semibold">$ {{ item.subtotal|floatformat:0 }}</td>
                        <td>
                            <button type="button"
                                    onclick="removeItem('{{ product_id }}')"
                                    class="btn btn-outline-danger btn-sm"
                                    title="ç§»é™¤å•†å“">
                                    ğŸ”´ ç§»é™¤
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>

        <div class="text-end mt-3 fs-5 fw-bold">
            ç¸½é‡‘é¡ï¼š<span id="total-display">${{ total}}</span>
        </div>
    </form>

    <!-- æ¸…ç©ºè³¼ç‰©è»Šè¡¨å–®ï¼ˆç¨ç«‹ï¼‰ -->
    <form id="clear-cart-form" method="post" action="{% url 'clear_cart' %}" onsubmit="return confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šå—ï¼Ÿ')" style="margin:0;">
        {% csrf_token %}
    </form>

    <!-- å››å€‹æŒ‰éˆ•åŒåˆ— -->
    <div class="btn-group-custom">
        <!-- æ›´æ–°è³¼ç‰©è»ŠæŒ‰éˆ•ï¼ŒæŒ‰ä¸‹è§¸ç™¼ update-cart-form -->
        <button type="submit" form="update-cart-form" class="btn btn-secondary flex-grow-1 flex-md-grow-0" style="min-width: 140px;">
            âœ… æ›´æ–°è³¼ç‰©è»Š
        </button>

        <!-- æ¸…ç©ºè³¼ç‰©è»ŠæŒ‰éˆ•ï¼ŒæŒ‰ä¸‹è§¸ç™¼ clear-cart-form -->
        <button type="submit" form="clear-cart-form" class="btn btn-danger flex-grow-1 flex-md-grow-0" style="min-width: 140px;">
            ğŸ—‘ï¸ æ¸…ç©ºè³¼ç‰©è»Š
        </button>

        <!-- ç¹¼çºŒè³¼ç‰© -->
        <a href="{% url 'product_list' %}" class="btn btn-outline-primary flex-grow-1 flex-md-grow-0" style="min-width: 140px;">
            ğŸ”™ ç¹¼çºŒè³¼ç‰©
        </a>

        <!-- æˆ‘è¦çµå¸³ -->
         <a href="#" onclick="startCheckout()" class="btn btn-success flex-grow-1 flex-md-grow-0" style="min-width: 140px;">
            ğŸ§¾ æˆ‘è¦çµå¸³
        </a>
    </div>

    {% for product_id, item in cart_items.items %}
    <form id="remove-form-{{ product_id }}" method="post" action="{% url 'remove_from_cart' product_id %}" style="display:none;">
        {% csrf_token %}
    </form>
    {% endfor %}

    {% else %}
        <p class="text-danger fs-5 text-left">ç›®å‰è³¼ç‰©è»Šæ˜¯ç©ºçš„ã€‚</p>
    {% endif %}
</div>
{% endblock %}
{% block script %}
<script>
function updateSubtotal(input) {
    const price = parseFloat(input.dataset.price);
    const quantity = parseInt(input.value);
    const row = input.closest('tr');
    const subtotalCell = row.querySelector('.subtotal-cell');

    if (!isNaN(price) && !isNaN(quantity)) {
        const subtotal = price * quantity;
        subtotalCell.textContent = `$${subtotal.toFixed(0)}`;
    }

    updateTotal();
}

function updateTotal() {
    let total = 0;
    let totalQuantity = 0;

    document.querySelectorAll('.quantity-input').forEach(input => {
        const price = parseFloat(input.dataset.price);
        const quantity = parseInt(input.value);
        if (!isNaN(price) && !isNaN(quantity)) {
            total += price * quantity;
            totalQuantity += quantity;
        }
    });

    const totalDisplay = document.getElementById('total-display');
    if (totalDisplay) {
        totalDisplay.textContent = `$${total.toFixed(0)}`;
    }

    // âœ… æ›´æ–° navbar çš„è³¼ç‰©è»Šå¾½ç« 
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
        cartCount.textContent = totalQuantity;
    }

    // âœ… å„²å­˜åˆ° localStorageï¼Œè®“å…¶ä»–é é¢èƒ½åŒæ­¥è®€åˆ°
    localStorage.setItem('cartCount', totalQuantity);
}

function removeItem(productId) {
    if(confirm('âš ï¸ ç¢ºå®šè¦ç§»é™¤é€™å€‹å•†å“å—ï¼Ÿ')) {
        const form = document.getElementById(`remove-form-${productId}`);
        if(form) {
            form.submit();
        }
    }
}

function startCheckout() {
    document.getElementById('go-to-checkout').value = '1';
    document.getElementById('update-cart-form').submit();
}

function showProductModal(name, imageUrl,price) {
    document.getElementById('modalProductName').textContent = name;
    document.getElementById('modalProductImage').src = imageUrl;
    document.getElementById('modalProductPrice').innerText = 'åƒ¹æ ¼ï¼š$' + price;
}


// âœ… ç”¨ AJAX æ›´æ–°å¾Œç«¯è³¼ç‰©è»Šæ•¸é‡
function updateQuantity(productId, quantity) {
    fetch("{% url 'update_cart_quantity' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `product_id=${productId}&quantity=${quantity}`
    })
    .then(res => res.json())
    .then(data => {
        console.log('å¾Œç«¯å·²æ›´æ–°è³¼ç‰©è»Š', data);
    });
}

document.addEventListener('DOMContentLoaded', function () {
    updateTotal();  // åˆå§‹åŒ–ç¸½é‡‘é¡èˆ‡å¾½ç« æ•¸é‡

    // âœ… ç‚ºæ¯å€‹æ•¸é‡è¼¸å…¥æ¡†åŠ ä¸Š input äº‹ä»¶ç›£è½
    document.querySelectorAll('.quantity-input').forEach(function(input) {
        input.addEventListener('input', function () {
            const productId = input.name.split('_')[1];  // å–å¾— product_id
            const quantity = parseInt(input.value);

            if (!isNaN(quantity) && quantity > 0) {
                updateQuantity(productId, quantity);  // åŒæ­¥å¾Œç«¯
                updateSubtotal(input);               // æ›´æ–°å‰ç«¯å°è¨ˆèˆ‡ç¸½é¡
            }
        });
    });
});
</script>
{% endblock %}

